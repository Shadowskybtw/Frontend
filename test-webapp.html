<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebApp Initialization</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>Test WebApp Initialization</h1>
    <div id="status"></div>
    <div id="logs"></div>
    
    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        
        function log(message) {
            console.log(message);
            logsDiv.innerHTML += '<p>' + message + '</p>';
        }
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º Telegram WebApp –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.Telegram = {
            WebApp: {
                initData: 'user=%7B%22id%22%3A937011437%2C%22first_name%22%3A%22%D0%9D%D0%B8%D0%BA%D0%BE%D0%BB%D0%B0%D0%B9%22%2C%22last_name%22%3A%22%D0%9C%D0%B8%D1%88%D0%B8%D0%BD%22%2C%22username%22%3Anull%2C%22language_code%22%3A%22ru%22%7D&chat_instance=-123456789&chat_type=sender&auth_date=1760223099&hash=test_hash',
                initDataUnsafe: {
                    user: {
                        id: 937011437,
                        first_name: '–ù–∏–∫–æ–ª–∞–π',
                        last_name: '–ú–∏—à–∏–Ω',
                        username: null,
                        language_code: 'ru'
                    }
                },
                ready: () => log('Telegram WebApp ready() called'),
                expand: () => log('Telegram WebApp expand() called')
            }
        };
        
        log('Telegram WebApp simulated');
        log('User data: ' + JSON.stringify(window.Telegram.WebApp.initDataUnsafe.user));
        
        // –¢–µ—Å—Ç–∏—Ä—É–µ–º API
        fetch('/api/check-or-register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-telegram-init-data': window.Telegram.WebApp.initData
            },
            body: JSON.stringify({
                tg_id: 937011437,
                firstName: '–ù–∏–∫–æ–ª–∞–π',
                lastName: '–ú–∏—à–∏–Ω',
                username: null
            })
        })
        .then(response => response.json())
        .then(data => {
            log('API Response: ' + JSON.stringify(data, null, 2));
            if (data.success) {
                statusDiv.innerHTML = '<p style="color: green;">‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</p>';
                if (data.isNewUser) {
                    statusDiv.innerHTML += '<p>üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</p>';
                } else {
                    statusDiv.innerHTML += '<p>üë§ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω</p>';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª—å
                if (!data.isNewUser) {
                    statusDiv.innerHTML += '<p style="color: blue;">üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª—å</p>';
                }
            } else {
                statusDiv.innerHTML = '<p style="color: red;">‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ' + data.message + '</p>';
            }
        })
        .catch(error => {
            log('API Error: ' + error.message);
            statusDiv.innerHTML = '<p style="color: red;">‚ùå –û—à–∏–±–∫–∞ API: ' + error.message + '</p>';
        });
        
        // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é WebApp
        setTimeout(() => {
            log('Redirecting to WebApp...');
            window.location.href = '/';
        }, 3000);
    </script>
</body>
</html>
