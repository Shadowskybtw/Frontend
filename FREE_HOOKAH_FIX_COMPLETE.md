# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å—è–Ω –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è

**–î–∞—Ç–∞:** 23 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –æ—á–∏—â–µ–Ω–æ

---

## üêõ –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 100% (5 –ø–ª–∞—Ç–Ω—ã—Ö –∫–∞–ª—å—è–Ω–æ–≤) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å—è–Ω
- –≠—Ç–æ—Ç –∫–∞–ª—å—è–Ω **—Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–ª—Å—è** –≤ –∏—Å—Ç–æ—Ä–∏—é (`hookah_history`)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –µ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ **–î–û** —Ç–æ–≥–æ, –∫–∞–∫ –Ω–∞–∂–∞–ª "–ü–æ–ª—É—á–∏—Ç—å"

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç 5-–π –ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å—è–Ω
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `free_hookahs` (unused=false)
3. ‚ùå **–°—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `hookah_history`** ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–ª—É—á–∏—Ç—å"
6. –ö–∞–ª—å—è–Ω –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ used

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç 5-–π –ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å—è–Ω
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `free_hookahs` (unused=false)
3. ‚è∏Ô∏è **–ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é**
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "–ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å—è–Ω"
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–ª—É—á–∏—Ç—å"
6. ‚úÖ –ö–∞–ª—å—è–Ω –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ used
7. ‚úÖ **–¢–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `hookah_history`**

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ API `/api/add-hookah`**

**–ë—ã–ª–æ:**
```typescript
if (newProgress >= 100) {
  await db.updateStockPromotionCompleted(stock.id, true)
  const freeHookah = await db.createFreeHookah(user.id)
  
  // ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
  await db.addHookahToHistory(user.id, 'free', ...)
  
  await db.updateStockProgress(stock.id, 0)
}
```

**–°—Ç–∞–ª–æ:**
```typescript
if (newProgress >= 100) {
  await db.updateStockPromotionCompleted(stock.id, true)
  
  // ‚úÖ –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ free_hookahs
  const freeHookah = await db.createFreeHookah(user.id)
  console.log(`‚úÖ Free hookah created. User must claim it to add to history.`)
  
  // ‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é!
  // –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ /api/claim-free-hookah
  
  await db.updateStockProgress(stock.id, 0)
}
```

### 2. **API `/api/claim-free-hookah` —É–∂–µ —Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ**

```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å—è–Ω
const usedHookah = await db.useFreeHookah(freeHookah.id)

// ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –¢–û–õ–¨–ö–û –ø—Ä–∏ –∫–ª–µ–π–º–µ
await db.addHookahToHistory(
  user.id, 
  'free', 
  undefined,
  stock.id,
  null,
  'user_claimed'
)
```

### 3. **Cleanup API –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π**

**Endpoint:** `POST /api/cleanup-unclaimed-free-hookahs`

**–õ–æ–≥–∏–∫–∞:**
1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö** (`used=true`) –≤ `free_hookahs`
   - –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **–≤ –∏—Å—Ç–æ—Ä–∏–∏** (`hookah_type='free'`)
   - –ï—Å–ª–∏ `history > used` ‚Üí —É–¥–∞–ª—è–µ–º –∏–∑–±—ã—Ç–æ–∫ (—Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ)

2. –ü—Ä–∏–º–µ—Ä:
   - –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 35 –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
   - –ù–æ —Ç–æ–ª—å–∫–æ 21 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –≤ `free_hookahs`
   - –£–¥–∞–ª—è–µ–º 14 —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
   - –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ 21 (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
curl -X POST https://url/api/cleanup-unclaimed-free-hookahs \
  -H "Content-Type: application/json" \
  -d '{"admin_tg_id": 937011437, "confirm": "CLEANUP_HISTORY"}'
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—Å—Ç–∫–∏

### –î–æ –æ—á–∏—Å—Ç–∫–∏:
- **Free –≤ –∏—Å—Ç–æ—Ä–∏–∏:** 35
- **Used –≤ free_hookahs:** 21
- **Unused –≤ free_hookahs:** 3
- **–ü—Ä–æ–±–ª–µ–º–∞:** 35 - 21 = 14 –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

### –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:
- **Free –≤ –∏—Å—Ç–æ—Ä–∏–∏:** 21 ‚úÖ
- **Used –≤ free_hookahs:** 21 ‚úÖ
- **Unused –≤ free_hookahs:** 3 ‚úÖ
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** 100% ‚úÖ

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:
- **–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–æ–±–ª–µ–º–æ–π:** 4
- **–£–¥–∞–ª–µ–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:** 17
- **–î–µ—Ç–∞–ª–∏:**
  - User 1: —É–¥–∞–ª–µ–Ω–æ 14, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ 21
  - User 6: —É–¥–∞–ª–µ–Ω–æ 1, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ 1
  - User 9: —É–¥–∞–ª–µ–Ω–æ 1, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ 0
  - User 237: —É–¥–∞–ª–µ–Ω–æ 1, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ 1

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

### –¢–∞–±–ª–∏—Ü–∞ `free_hookahs`:
```
user_id | used | count
--------|------|------
   1    | true |  21   ‚Üê –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ
   1    | false|   3   ‚Üê –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è
```

### –¢–∞–±–ª–∏—Ü–∞ `hookah_history`:
```
SELECT COUNT(*) FROM hookah_history 
WHERE user_id = 1 AND hookah_type = 'free'
‚Üí 21 –∑–∞–ø–∏—Å–µ–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç used=true –≤ free_hookahs)
```

### –õ–æ–≥–∏–∫–∞:
1. ‚úÖ –í –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ —Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–∞–ª—å—è–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ **—Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã** (used=true)
2. ‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è (used=false) **–ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è** –≤ –∏—Å—Ç–æ—Ä–∏–∏
3. ‚úÖ –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–ü–æ–ª—É—á–∏—Ç—å":
   - –ó–∞–ø–∏—Å—å –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ used=true
   - –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é
   - –ü–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ

---

## üéØ –ò—Ç–æ–≥

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:**
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å—è–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ **–¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –∫–ª–µ–π–º–∞**
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–∞–ª—å—è–Ω—ã)
- ‚úÖ –°—Ç–∞—Ä—ã–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ—á–∏—â–µ–Ω—ã
- ‚úÖ –í—Å–µ 4 –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

**–î–∞–ª—å–Ω–µ–π—à–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 100% —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `free_hookahs` (unused)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "–ü–æ–ª—É—á–∏—Ç—å"
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –∫–∞–ª—å—è–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏

**–ó–∞—â–∏—Ç–∞ –Ω–∞ –±—É–¥—É—â–µ–µ:**
- –ö–æ–¥ –≤ `add-hookah` –±–æ–ª—å—à–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî `claim-free-hookah`
- Cleanup API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º

