# ⭐ Система отзывов

**Дата:** 23 октября 2025  
**Статус:** ✅ Полностью работает

---

## 📋 Описание

Пользователи могут оценивать кальяны (платные и бесплатные) по шкале от 1 до 5 звезд и оставлять текстовые комментарии.

---

## 🎨 Дизайн модального окна

### Визуальные элементы:

1. **Overlay:**
   - Полупрозрачный черный фон (75%)
   - Размытие (backdrop-blur)
   - Клик снаружи закрывает окно

2. **Модальное окно:**
   - Градиентный фон (gray-900 → gray-800)
   - Фиолетовая рамка с свечением
   - Тень с фиолетовым оттенком
   - Анимация появления (slideUp)

3. **Звезды:**
   - Размер: 5xl (огромные)
   - Желтые с свечением (выбранные)
   - Серые (невыбранные)
   - Hover эффект: scale(1.25)
   - Плавная анимация (200ms)

4. **Эмодзи feedback:**
   - 5 звезд → 🎉 Отлично!
   - 4 звезды → 😊 Хорошо
   - 3 звезды → 😐 Нормально
   - 2 звезды → 😕 Плохо
   - 1 звезда → 😞 Очень плохо

5. **Текстовое поле:**
   - Placeholder: "Расскажите о своих впечатлениях..."
   - Максимум: 200 символов
   - Счетчик символов
   - Фиолетовая рамка при фокусе

6. **Кнопки:**
   - **Отмена:** Серая, hover эффект
   - **Отправить:** Градиент (purple → blue), свечение
   - Hover: scale(1.05)
   - Loading: Спиннер + текст "Отправляем..."

---

## 🔧 Технические детали

### API Endpoint: `/api/add-review`

**Request:**
```json
{
  "tgId": 937011437,
  "hookahId": 123,
  "rating": 5,
  "reviewText": "Отличный кальян!" // optional
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Review added successfully"
}
```

**Response (Error):**
```json
{
  "success": false,
  "message": "Error description"
}
```

### База данных: `hookah_reviews`

```sql
CREATE TABLE hookah_reviews (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  hookah_id INTEGER NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  review_text TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, hookah_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (hookah_id) REFERENCES hookah_history(id) ON DELETE CASCADE
);
```

### Prisma Model:

```typescript
model HookahReview {
  id            Int      @id @default(autoincrement())
  user_id       Int
  hookah_id     Int
  rating        Int
  review_text   String?
  created_at    DateTime @default(now())
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, hookah_id])
  @@map("hookah_reviews")
}
```

---

## 🎯 Функциональность

### 1. Добавление отзыва

**Шаги:**
1. Пользователь заходит на страницу "История"
2. Нажимает кнопку "⭐ Оценить" на любом кальяне
3. Выбирает количество звезд (1-5)
4. Опционально добавляет текстовый комментарий
5. Нажимает "✨ Отправить отзыв"
6. Видит зеленое уведомление "✅ Отзыв успешно добавлен!"
7. История обновляется, отзыв отображается

### 2. Редактирование отзыва

**Шаги:**
1. Если отзыв уже существует, кнопка меняется на "✏️ Изменить"
2. При клике открывается модальное окно с текущим рейтингом
3. Пользователь изменяет рейтинг/текст
4. Отправляет обновленный отзыв
5. Старый отзыв заменяется новым (UNIQUE constraint)

### 3. Отображение в истории

**Формат:**
```
┌─────────────────────────────────┐
│ ★★★★★ (5/5)                     │
│ "Отличный кальян!"              │
└─────────────────────────────────┘
```

- Все 5 звезд (желтые заполненные, серые пустые)
- Рейтинг в скобках
- Текст отзыва курсивом (если есть)
- Серый фон, рамка

---

## 📊 Валидация

### Frontend:
- ✅ Rating: 1-5 (выбор из звезд)
- ✅ Review text: макс. 200 символов
- ✅ Review text: опциональный

### Backend:
- ✅ tgId: обязательный
- ✅ hookahId: обязательный
- ✅ rating: обязательный, 1-5
- ✅ Пользователь может оценивать только свои покупки
- ✅ Один отзыв на один кальян (UNIQUE constraint)

---

## 🎨 Анимации

### CSS (globals.css):

```css
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

### Использование:
- `animate-fadeIn` → Overlay (200ms)
- `animate-slideUp` → Modal + Toast (300ms)
- `hover:scale-125` → Stars
- `hover:scale-105` → Buttons

---

## 🔄 Обновление отзыва

### Логика (Prisma):

```typescript
await prisma.hookahReview.upsert({
  where: {
    user_id_hookah_id: {
      user_id: userId,
      hookah_id: hookahId
    }
  },
  update: {
    rating: rating,
    review_text: reviewText
  },
  create: {
    user_id: userId,
    hookah_id: hookahId,
    rating: rating,
    review_text: reviewText
  }
})
```

---

## ✅ Проверка работы

### Тест 1: Добавление отзыва
1. Зайти на страницу "История"
2. Нажать "⭐ Оценить" на любом кальяне
3. Выбрать 5 звезд
4. Написать "Отличный кальян!"
5. Нажать "Отправить отзыв"
6. ✅ Должно появиться зеленое уведомление
7. ✅ Отзыв должен отобразиться в истории

### Тест 2: Редактирование отзыва
1. Нажать "✏️ Изменить" на кальяне с отзывом
2. Изменить рейтинг на 4 звезды
3. Изменить текст на "Хороший кальян"
4. Нажать "Отправить отзыв"
5. ✅ Отзыв должен обновиться

### Тест 3: Отображение
1. В истории должны быть видны:
   - ✅ Все 5 звезд (желтые/серые)
   - ✅ Рейтинг в скобках
   - ✅ Текст отзыва
2. Кнопка должна быть:
   - ✅ Градиентная с свечением (без отзыва)
   - ✅ Серая (с отзывом)

---

## 🎯 Итог

**Система отзывов полностью работает:**
- ✅ Красивый UI с анимациями
- ✅ 5-звездочная система оценки
- ✅ Текстовые комментарии (до 200 символов)
- ✅ Редактирование отзывов
- ✅ Уникальность (1 отзыв на кальян)
- ✅ Валидация на всех уровнях
- ✅ Уведомления об успехе/ошибке

**Готово к использованию!** ⭐

