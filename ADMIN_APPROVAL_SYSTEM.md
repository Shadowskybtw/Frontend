# 🎁 Система подтверждения бесплатных кальянов для админов

**Дата:** 23 октября 2025  
**Статус:** ✅ Полностью работает

---

## 📋 Концепция

Вместо автоматической выдачи бесплатных кальянов, теперь пользователи **отправляют запрос**, который видят **ВСЕ админы**. Любой админ может **подтвердить или отклонить** запрос.

---

## 🔄 Процесс

### Для пользователя:

1. **Заполняет 5 слотов** (получает 5 платных кальянов)
2. **Видит "Доступно бесплатных кальянов: 1"**
3. **Нажимает "🎁 Запросить бесплатный кальян"**
4. **Получает уведомление:** "✅ Запрос отправлен! Администратор подтвердит получение кальяна в ближайшее время."
5. **Ждет подтверждения от админа**
6. **После подтверждения:** кальян появляется в истории, можно забрать

### Для админа:

1. **Видит уведомление** в навигации (красный badge с цифрой)
2. **Переходит на страницу "🎁 Запросы"**
3. **Видит карточку запроса:**
   - Имя и телефон пользователя
   - Время запроса
   - Кнопки: ✅ Выдать / ❌ Отклонить
4. **Нажимает "✅ Выдать"**
5. **Система автоматически:**
   - Помечает бесплатный кальян как использованный
   - Добавляет запись в историю
   - Сбрасывает флаг `promotion_completed`
   - Обновляет статус запроса на `approved`
6. **Получает уведомление:** "✅ Запрос подтвержден!"

---

## 🗄️ База данных

### Таблица: `free_hookah_requests`

```sql
CREATE TABLE free_hookah_requests (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  stock_id INTEGER NOT NULL,
  status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected
  approved_by INTEGER,                  -- ID админа в таблице admins
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (stock_id) REFERENCES stocks(id) ON DELETE CASCADE,
  FOREIGN KEY (approved_by) REFERENCES admins(id) ON DELETE SET NULL
);
```

### Статусы:

- **`pending`** — Ожидает подтверждения
- **`approved`** — Подтвержден (кальян выдан)
- **`rejected`** — Отклонен

---

## 🔧 API Endpoints

### 1. Создание запроса (Пользователь)

**Endpoint:** `POST /api/free-hookah-requests/create`

**Request:**
```json
{
  "tg_id": 937011437
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "✅ Запрос отправлен! Ожидайте подтверждения от администратора.",
  "request": {
    "id": 123,
    "status": "pending",
    "created_at": "2025-10-23T12:00:00Z"
  }
}
```

**Response (Error - Already has pending):**
```json
{
  "success": false,
  "message": "У вас уже есть ожидающий подтверждения запрос. Дождитесь ответа администратора.",
  "requestId": 122
}
```

**Валидация:**
- ✅ Пользователь существует
- ✅ Есть неиспользованные бесплатные кальяны
- ✅ Нет других pending запросов от этого пользователя
- ✅ Активная акция существует

---

### 2. Список запросов (Админ)

**Endpoint:** `GET /api/free-hookah-requests/list`

**Query Parameters:**
- `admin_tg_id` (required) — Telegram ID админа
- `status` (optional) — `all`, `pending`, `approved`, `rejected` (default: all)

**Response:**
```json
{
  "success": true,
  "requests": [
    {
      "id": 123,
      "user": {
        "id": 1,
        "tg_id": "937011437",
        "name": "Николай Шадовский",
        "phone": "+79270036642",
        "username": "shadowskydie"
      },
      "status": "pending",
      "approver": null,
      "created_at": "2025-10-23T12:00:00Z",
      "updated_at": "2025-10-23T12:00:00Z"
    }
  ],
  "stats": {
    "total": 10,
    "pending": 3,
    "approved": 5,
    "rejected": 2
  }
}
```

**Валидация:**
- ✅ Админ существует
- ✅ Админ имеет права (в таблице `admins` или `ADMIN_TG_ID` в env)

---

### 3. Подтверждение/Отклонение (Админ)

**Endpoint:** `POST /api/free-hookah-requests/approve`

**Request:**
```json
{
  "request_id": 123,
  "admin_tg_id": 937011437,
  "action": "approve"  // или "reject"
}
```

**Response (Success - Approved):**
```json
{
  "success": true,
  "message": "✅ Запрос подтвержден! Бесплатный кальян выдан пользователю.",
  "request": {
    "id": 123,
    "status": "approved",
    "user": {
      "name": "Николай Шадовский",
      "phone": "+79270036642"
    }
  }
}
```

**Response (Success - Rejected):**
```json
{
  "success": true,
  "message": "❌ Запрос отклонен.",
  "request": {
    "id": 123,
    "status": "rejected",
    "user": {
      "name": "Николай Шадовский",
      "phone": "+79270036642"
    }
  }
}
```

**Что происходит при approve:**
1. Обновляет статус запроса → `approved`
2. Создает или получает запись админа в таблице `admins`
3. Сохраняет `approved_by` = `admin.id`
4. Находит первый неиспользованный бесплатный кальян
5. Помечает его как использованный (`used=true`)
6. Добавляет запись в `hookah_history` (type='free', scan_method='admin_approved')
7. Сбрасывает `promotion_completed` → false

**Валидация:**
- ✅ Админ имеет права
- ✅ Запрос существует
- ✅ Запрос в статусе `pending`
- ✅ У пользователя есть неиспользованные бесплатные кальяны (только для approve)

---

## 🎨 Админ панель

### Страница: `/admin-requests`

**Только для админов!** При попытке доступа без прав → "🚫 Доступ запрещен"

### Элементы интерфейса:

#### 1. Header с градиентом
```
🎁 Запросы на бесплатные кальяны          [🔄 Обновить]
```
- Фиолетово-синий градиент
- Кнопка обновления

#### 2. Статистика (4 панели)
```
┌──────┬──────┬──────┬──────┐
│ Всего│Ожидают│Одобрено│Отклонено│
│  10  │   3   │   5   │   2   │
└──────┴──────┴──────┴──────┘
```
- Всего: черный фон
- Ожидают: желтый (border + text)
- Одобрено: зеленый
- Отклонено: красный

#### 3. Фильтры (4 кнопки)
```
[📋 Все] [⏳ Ожидают] [✅ Одобрено] [❌ Отклонено]
```
- Активный: градиент purple→blue
- Неактивный: серый

#### 4. Список запросов

**Pending запрос:**
```
┌────────────────────────────────────────┐
│ ⏳ Николай Шадовский                   │
│ 📞 +79270036642                        │
│ @shadowskydie                          │
│                                        │
│ 🕐 23 октября 2025, 12:00             │
│                                        │
│            [✅ Выдать] [❌ Отклонить]  │
└────────────────────────────────────────┘
```
- Желтая рамка с эффектом hover
- Кнопки с градиентом и shadow
- Hover: scale(1.05)

**Approved запрос:**
```
┌────────────────────────────────────────┐
│ ✅ Николай Шадовский      [✅ Выдан]   │
│ 📞 +79270036642                        │
│ 🕐 23 октября 2025, 12:00             │
│ 👤 Обработал: Админ Админович          │
└────────────────────────────────────────┘
```
- Зеленая рамка (слабая)
- Зеленый badge "✅ Выдан"

**Rejected запрос:**
```
┌────────────────────────────────────────┐
│ ❌ Николай Шадовский    [❌ Отклонен]  │
│ 📞 +79270036642                        │
│ 🕐 23 октября 2025, 12:00             │
│ 👤 Обработал: Админ Админович          │
└────────────────────────────────────────┘
```
- Красная рамка (слабая)
- Красный badge "❌ Отклонен"

---

## 🔔 Уведомления

### В навигации

**Для админов добавляется 4-я кнопка:**
```
[👤 Профиль] [📊 История] [📈 Статистика] [🎁 Запросы (3)]
```
- Красный badge с числом pending запросов
- Анимация pulse (пульсация)
- Обновление каждые 30 секунд

### Toast уведомления

**При успешном подтверждении:**
```
┌──────────────────────┐
│ ✅ Запрос подтвержден│
└──────────────────────┘
```
- Зеленый фон
- Появляется top-right
- Автоматически исчезает через 3 сек

**При отклонении:**
```
┌──────────────────────┐
│ ❌ Запрос отклонен   │
└──────────────────────┘
```
- Оранжевый фон

---

## ⚡ Автообновление

### Админ панель:
- **Pending фильтр:** обновление каждые **10 секунд**
- **Другие фильтры:** только ручное обновление

### Навигация (badge):
- Обновление каждые **30 секунд**
- Только для админов

---

## 🎯 Преимущества системы

### 1. **Защита от мошенничества**
   - Бесплатный кальян выдается только после подтверждения админа
   - Нельзя получить несколько раз (проверка pending запросов)

### 2. **Удобство для админов**
   - Все запросы в одном месте
   - Любой админ может обработать
   - Полная история (кто и когда подтвердил)

### 3. **Прозрачность**
   - Пользователь видит, что запрос отправлен
   - Админы видят всю информацию о пользователе
   - Audit trail (логи всех действий)

### 4. **Real-time обновления**
   - Badge в навигации показывает количество pending
   - Автообновление списка
   - Toast уведомления

### 5. **Масштабируемость**
   - Несколько админов могут работать одновременно
   - Первый подтвердивший "забирает" запрос
   - Нет конфликтов (optimistic locking)

---

## 🧪 Тестирование

### Тест 1: Создание запроса
1. Заполнить 5 слотов (5 платных кальянов)
2. Нажать "🎁 Запросить бесплатный кальян"
3. ✅ Должно появиться зеленое уведомление
4. ✅ Запрос должен появиться в админ панели

### Тест 2: Подтверждение запроса
1. Зайти в `/admin-requests` как админ
2. Увидеть pending запрос
3. Нажать "✅ Выдать"
4. ✅ Должно появиться уведомление "Запрос подтвержден"
5. ✅ Запрос должен исчезнуть из pending
6. ✅ Кальян должен появиться в истории пользователя
7. ✅ Free hookah должен быть помечен как used

### Тест 3: Отклонение запроса
1. Нажать "❌ Отклонить"
2. ✅ Должно появиться уведомление "Запрос отклонен"
3. ✅ Запрос должен переместиться в "Отклонено"
4. ✅ Кальян НЕ должен появиться в истории

### Тест 4: Badge в навигации
1. Создать запрос как пользователь
2. Зайти как админ
3. ✅ Должен появиться красный badge с цифрой "1"
4. Подтвердить запрос
5. ✅ Badge должен исчезнуть (или показывать "0")

### Тест 5: Дубликаты
1. Создать запрос
2. Попытаться создать еще один
3. ✅ Должна появиться ошибка: "У вас уже есть ожидающий подтверждения запрос"

---

## ✅ Итог

**Система полностью функциональна:**
- ✅ Пользователи могут запрашивать бесплатные кальяны
- ✅ Админы видят все запросы в реальном времени
- ✅ Красивый интерфейс с анимациями
- ✅ Badge с уведомлениями
- ✅ Автообновление данных
- ✅ Полный audit trail
- ✅ Защита от мошенничества

**Готово к использованию!** 🎁

